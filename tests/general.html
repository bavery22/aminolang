<html>
<head>
<script src='../src/jscanvas/init.js'></script>
<script src='../build/jscanvas/out.js'></script>
<script src='../src/jscanvas/handcoded7.js'></script>
<script src='../src/jscanvas/monkeypatch.js'></script>
<style type="text/css">
canvas { border: 1px solid black; }
</style>
</head>
<body>
<canvas id='mycanvas' width='600' height='300'></canvas>
<script language="JavaScript">
Corex.start(function(core) {
    var root = core.createStage('mycanvas');
    
        function elasticIn(t) {
            var p = 0.3;
            return -(Math.pow(2,10*(t-1)) * Math.sin(((t-1)-p/4)*(2*Math.PI)/p));
        }
        function elasticOut(t) {
            var p = 0.3;
            return Math.pow(2,-10*t) * Math.sin((t-p/4)*(2*Math.PI)/p) + 1;
        }
        function cubicIn(t) {
            return Math.pow(t,3);
        }
        function cubicOut(t) {
            return 1-cubicIn(1-t);
        }
        function smoothstepIn(t) {
            return t*t*(3-2*t);
        }
        
        function cubicInOut(t) {
            if(t < 0.5) return cubicIn(t*2.0)/2.0;
            return 1-cubicIn((1-t)*2)/2;                
        }
    function camelize(s) {
        return s.substring(0,1).toUpperCase() + s.substring(1);
    }
    
    function a(node, prop, start, finish, dur) {
        return {
            node:node,
            prop:prop,
            sval:start,
            fval:finish,
            dur:dur,
            running:false,
            finished:false,
            easefn:null,
            update:function() {
                if(this.finished) return;
                if(!this.running) {
                    this.startTime = new Date().getTime();
                    this.running = true;
                    return;
                }
                var time = new Date().getTime();
                var dt = time-this.startTime;
                var t = dt/this.dur;
                if(t > 1) {
                    this.finished = true;
                    return;
                }
                if(this.easefn != null) {
                    t = this.easefn(t);
                }
                var v = (this.fval-this.sval)*t + this.sval;
                //console.log("t = " + t + " " + v);
                node["set"+camelize(this.prop)](v);
            },
            setEase:function(easefn) {
                this.easefn = easefn;
                return this;
            }
        };
    }
    
    function chain() {
        var args = Array.prototype.slice.call(arguments);
        return {
            anims:args,
            curr:null,
            finished:false,
            afterf:null,
            update:function() {
                if(this.finished) return;
                if(!this.curr) {
                    this.curr = this.anims.shift();
                }
                this.curr.update();
                if(this.curr.finished) {
                    if(this.anims.length == 0) {
                        this.finished = true;
                        if(this.afterf) this.afterf();
                    } else {
                        this.curr = this.anims.shift();
                    }
                }
                
            },
            after:function(f) {
                this.afterf = f;
                return this;
            }
        }
    }
    
    function together() {
        var args = Array.prototype.slice.call(arguments);
        return {
            anims:args,
            finished:false,
            update:function() {
                if(this.finished) return;
                var anyLeft = false;
                for(var i in this.anims) {
                    if(!this.anims[i].finished) {
                        this.anims[i].update();
                        anyLeft = true;
                    }
                }
                if(!anyLeft) {
                    this.finished = true;
                    if(this.afterf) this.afterf();
                }
            },
            after:function(f) {
                this.afterf = f;
                return this;
            }
        }
    }
    
    function shapes(c) {
        var rect = core.createRect();
        rect.setX(100).setY(100).setW(50).setH(25).setFill("green");
        c.add(rect);
        
        root.on(Events.Press, rect, function() { 
            if(rect.getFill() == 'blue') {
                rect.setFill("red");
            } else {
                rect.setFill('blue'); 
            }
        }); 
        
        var circle = core.createCircle();
        circle.setCx(50).setCy(100).setRadius(30).setFill('green');
        c.add(circle);
    
        
        //e.target is a generic reference to the drag target.
        //e.deltaX is how much the x moved between events, regardless of the current
        //coordinate space's movement (ie: setting the x and y)
        //drag works even if you drag quickly and go outside the target, thus it
        //preserves the drag target through the entire gesture
        root.on(Events.Drag, circle, function(e) {
            e.target.setCx(e.target.getCx() + e.delta.getX());
            e.target.setCy(e.target.getCy() + e.delta.getY());
        });
        
        
        var r2 = core.createRect();
        r2.setX(60).setY(100).setW(50).setH(50).setFill("yellow").setOpacity(0.5);
        c.add(r2);
    }

    
    
    
    
    function comps(c) {
        
        var button = core.createPushButton();
        button.setText("button");
        button.setX(200);
        button.setY(50);
        c.add(button);
        
    
        var tbutton = core.createToggleButton();
        tbutton.setText("toggle");
        tbutton.setX(200);
        tbutton.setY(100);
        c.add(tbutton);
        
        var label = core.createLabel();
        label.setText("label");
        label.setX(200);
        label.setY(130);
        c.add(label);
        
        var slider = core.createSlider();
        slider.setTx(200);
        slider.setY(160);
        slider.setW(100);
        slider.setH(20);
        c.add(slider);
        
        
        
        var textbox = core.createTextbox();
        textbox.setX(200);
        textbox.setY(190);
        textbox.setW(100);
        textbox.setH(20);
        textbox.setText("foo");
        /*
        root.on(Events.KeyPress, textbox, function(e) {
            var t = textbox.getText();
            if(!t) t = "";
            
            if(e.e.keyCode == 45 || e.e.keyCode == 8) {
                if(t.length > 0) {
                    t = t.substring(0,t.length-1);
                    textbox.setText(t);
                    return;
                }
            }
            var ch = String.fromCharCode(e.e.keyCode);
            if(e.e.shiftKey) {
                ch = ch.toUpperCase();
            } else {
                ch = ch.toLowerCase();
            }
            textbox.settext(t+ch);
        });
        */
        c.add(textbox);
    }
    
    
    function events(c) {
        
        var b1 = new PushButton().setText("no trans").setX(10).setY(100);
        c.add(b1);
        
        var b2 = new PushButton().setText("trans xy").setTx(120).setTy(100);
        c.add(b2);
        
        var b3 = new PushButton().setText("group trans").setTx(0).setTy(0);
        var g3 = new Group().setTx(230).setTy(100);
        g3.add(b3);
        c.add(g3);
        
        var b4 = new PushButton().setText("rotate").setTx(0).setTy(0);
        var g4 = new Transform().setTx(10).setTy(150).setRotate(45);
        g4.setChild(b4);
        c.add(g4);
        
        var b5 = new PushButton().setText("scale").setTx(0).setTy(0);
        var g5 = new Transform().setTx(120).setTy(150).setScalex(2).setScaley(2);
        g5.setChild(b5);
        c.add(g5);
        
        
        var slider = core.createSlider();
        slider.setTx(100);
        slider.setTy(50);
        c.add(slider);
        
    }
    
    function anims(c) {
        var rect = new Rect();    
        rect.setX(0);
        rect.setY(0);
        rect.setW(20);
        rect.setH(20);
        rect.setFill("red");
        c.add(rect);
        var anim = chain(
            together(
                a(rect,"x",0,100,1000),
                a(rect,"y",0,100,1000)
            ),
            chain(
                a(rect,"x",100, 200,1000).setEase(elasticOut),
                a(rect,"y",100,  50,500).setEase(cubicInOut),
                a(rect,"x",200, 100,500).setEase(cubicInOut)
            ),
            together(
                a(rect,"x",100,0,500).setEase(cubicInOut),
                a(rect,"y",50, 0,500).setEase(cubicInOut)
            )
            ).after(function() {
                console.log("all done!");
            });
        root.addAnim(anim);
    }
    
    var tests = [shapes,comps,events,anims];
    var current = -1;
    var testgroup = new Group();
    root.add(testgroup);
    
    
    var prevButton = core.createPushButton();
    prevButton.setText("prev").setX(10).setY(10).setW(80).setH(20);
    root.add(prevButton);
    root.on(Events.Press,prevButton,function(e){
        testgroup.clear();
        current = current - 1;
        if(current < 0) {
            current = tests.length-1;
        }
        tests[current](testgroup);
    });
    
    var nextButton = core.createPushButton();
    nextButton.setText("next").setX(100).setY(10).setW(80).setH(20);
    root.add(nextButton);
    root.on(Events.Press,nextButton,function(e) {
        testgroup.clear();
        current = current + 1;
        if(current >= tests.length) {
            current = 0;
        }
        tests[current](testgroup);
    });
});
</script>
</body>
</html>
